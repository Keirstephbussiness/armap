<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR Campus Demo - Joylens Store</title>

    <!-- A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <!-- Tailwind for UI -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body { 
        margin: 0; 
        overflow: hidden; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      #menu {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255,255,255,0.95);
        border-radius: 12px;
        padding: 15px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
      }
      
      #infoCard {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        max-width: 400px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        overflow: hidden;
        display: none;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
      }
      
      #infoCard.show {
        transform: translateY(0);
        opacity: 1;
      }
      
      #infoCard.hidden {
        transform: translateY(100px);
        opacity: 0;
      }
      
      #closeButton {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        background: rgba(255,255,255,0.9);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: background 0.2s;
      }
      
      #closeButton:hover {
        background: rgba(255,255,255,1);
      }
      
      .building-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }
      
      .info-content {
        padding: 20px;
      }
      
      .distance-badge {
        display: inline-block;
        background: #3b82f6;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 10px;
      }
      
      .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
      }
      
      .waypoint-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .waypoint-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      
      .directions-btn {
        background: #10b981;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
        font-weight: 500;
        margin-top: 10px;
        width: 100%;
      }
      
      .directions-btn:hover {
        background: #059669;
      }
    </style>
  </head>
  <body>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner"></div>
    
    <!-- Menu -->
    <div id="menu" class="shadow-lg">
      <h2 class="text-xl font-bold mb-3 text-gray-800">üìç AR Campus Navigator</h2>
      <button onclick="goToJoylens()" class="waypoint-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        Set Waypoint
      </button>
      <div class="mt-3 text-xs text-gray-600">
        <p>üëÜ Point camera at buildings or markers</p>
        <p>üì± Tap markers for info</p>
      </div>
    </div>

    <!-- Info Card -->
    <div id="infoCard" class="hidden">
      <span id="closeButton" onclick="hideInfo()">&times;</span>
      
      <!-- Building Image -->
      <img id="buildingImage" class="building-image" src="" alt="Building">
      
      <!-- Info Content -->
      <div class="info-content">
        <h3 id="infoName" class="text-xl font-bold text-gray-800"></h3>
        <p id="infoDesc" class="text-sm text-gray-600 mt-2"></p>
        <div class="distance-badge" id="infoDistance">Calculating...</div>
        
        <!-- Get Directions Button -->
        <button onclick="getDirections()" class="directions-btn">
          üß≠ Get Directions
        </button>
      </div>
    </div>

    <!-- AR Scene -->
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false; sourceWidth: 1280; sourceHeight: 720;"
      loading-screen="enabled: false"
    >
      <a-camera gps-camera rotation-reader>
        <!-- HUD overlay -->
        <a-entity
          position="0 -0.4 -1"
          geometry="primitive: plane; width: 1; height: 0.2"
          material="color: #1e293b; opacity: 0.7"
          text="value: Joylens Store Navigator (Indoor/Outdoor); align: center; color: white; font: roboto; width: 2"
        ></a-entity>
      </a-camera>

      <!-- Joylens Store GPS Marker -->
      <a-entity
        id="joylensGpsMarker"
        gps-entity-place="latitude: 14.370209559833405; longitude: 120.92365054409018"
        clickable
      >
        <!-- Store Building Model -->
        <a-box
          color="#ef4444"
          depth="3"
          height="5"
          width="3"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"
          material="shader: standard; metalness: 0.2; roughness: 0.8"
        ></a-box>
        
        <!-- Store Label -->
        <a-text
          value="JOYLENS STORE"
          align="center"
          position="0 3.5 0"
          scale="2.5 2.5 2.5"
          color="#ffffff"
          font="roboto"
          geometry="primitive: plane; width: 2.5; height: 0.8"
          material="color: #ef4444; opacity: 0.9"
        ></a-text>
        
        <!-- Floating Pin Icon -->
        <a-entity
          geometry="primitive: sphere; radius: 0.4"
          material="color: #facc15"
          position="0 4.5 0"
          animation="property: position; to: 0 5 0; dir: alternate; loop: true; dur: 800"
        ></a-entity>
      </a-entity>

      <!-- Joylens Store NFT Marker for Indoor -->
      <a-nft
        type="nft"
        url="https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/trex"  <!-- Replace with your NFT descriptors path -->
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        smoothThreshold="5"
        clickable
      >
        <!-- Store Building Model (same as GPS) -->
        <a-box
          color="#ef4444"
          depth="3"
          height="5"
          width="3"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"
          material="shader: standard; metalness: 0.2; roughness: 0.8"
        ></a-box>
        
        <!-- Store Label -->
        <a-text
          value="JOYLENS STORE (Indoor Marker)"
          align="center"
          position="0 3.5 0"
          scale="2.5 2.5 2.5"
          color="#ffffff"
          font="roboto"
          geometry="primitive: plane; width: 2.5; height: 0.8"
          material="color: #ef4444; opacity: 0.9"
        ></a-text>
        
        <!-- Floating Pin Icon -->
        <a-entity
          geometry="primitive: sphere; radius: 0.4"
          material="color: #facc15"
          position="0 4.5 0"
          animation="property: position; to: 0 5 0; dir: alternate; loop: true; dur: 800"
        ></a-entity>
      </a-nft>

      <!-- Real-Time Direction Arrow (Compound: Shaft + Head) -->
      <a-entity id="directionArrow" position="0 -0.5 -3" visible="false">
        <!-- Arrow Shaft (Cylinder) -->
        <a-entity
          geometry="primitive: cylinder; radius: 0.1; height: 1.5"
          material="color: #22d3ee; opacity: 0.85; shader: standard"
          position="0 0.75 0"
          rotation="90 0 0"
        ></a-entity>
        <!-- Arrow Head (cone) -->
        <a-entity
          geometry="primitive: cone; radiusBottom: 0.3; radiusTop: 0; height: 0.6"
          material="color: #22d3ee; opacity: 0.85; shader: standard"
          position="0 0 0"
        ></a-entity>
      </a-entity>
    </a-scene>

    <script>
      // Joylens Store data
      const joylens = {
        name: "Joylens Store",
        lat: 14.370209559833405,
        lng: 120.92365054409018,
        desc: "A local convenience and optical store offering eyewear, school supplies, and daily essentials within the campus area.",
        image: "https://lh3.googleusercontent.com/p/AF1QipMHNCOzFG0I9eGl41Sn28yy2sLe1BLj8EPPDvAv=s1360-w1360-h1020-rw"
      };

      let userPosition = null;
      let waypointActive = false;
      let lastBearing = 0;
      let deviceHeading = 0;
      let lastTimestamp = 0;
      let velocity = { x: 0, y: 0, z: 0 };
      let isIndoor = false; // Flag for indoor mode (detected by poor GPS accuracy)

      // Hide loading spinner when AR scene is ready
      window.addEventListener('arjs-video-loaded', () => {
        document.getElementById('loadingSpinner').style.display = 'none';
      });

      // Handle device orientation for compass heading
      if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', (event) => {
          if (event.alpha !== null) {
            deviceHeading = event.alpha; // Compass heading in degrees (0 = North)
          }
        });
      } else {
        console.warn("DeviceOrientationEvent not supported");
      }

      // Handle device motion for dead reckoning (indoor fallback)
      if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', (event) => {
          if (isIndoor && event.timestamp && lastTimestamp) {
            const dt = (event.timestamp - lastTimestamp) / 1000; // Delta time in seconds
            const acc = event.acceleration || { x: 0, y: 0, z: 0 }; // Linear acceleration (fallback to 0)
            // Simple integration (add filtering in production)
            velocity.x += acc.x * dt;
            velocity.y += acc.y * dt;
            velocity.z += acc.z * dt;
            // Update position (assume flat plane, adjust for heading)
            const headingRad = deviceHeading * Math.PI / 180;
            userPosition.latitude += (velocity.y * Math.cos(headingRad) - velocity.x * Math.sin(headingRad)) / 111111; // Approx m to lat
            userPosition.longitude += (velocity.y * Math.sin(headingRad) + velocity.x * Math.cos(headingRad)) / (111111 * Math.cos(userPosition.latitude * Math.PI / 180)); // Approx m to lon
          }
          lastTimestamp = event.timestamp;
        });
      } else {
        console.warn("DeviceMotionEvent not supported - No indoor dead reckoning");
      }

      // Calculate distance between two GPS coordinates (Haversine formula)
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Earth's radius in meters
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                  Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in meters
      }

      // Format distance for display
      function formatDistance(meters) {
        if (meters < 1000) {
          return `${Math.round(meters)} meters away`;
        } else {
          return `${(meters / 1000).toFixed(2)} km away`;
        }
      }

      // Calculate bearing between two points
      function calculateBearing(lat1, lon1, lat2, lon2) {
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
        const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                  Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
        const bearing = Math.atan2(y, x);
        return (bearing * 180 / Math.PI + 360) % 360;
      }

      // Smooth bearing to reduce jitter
      function smoothBearing(newBearing) {
        const alpha = 0.1; // Smoothing factor (0 to 1, lower is smoother)
        lastBearing = (alpha * newBearing + (1 - alpha) * lastBearing) % 360;
        return lastBearing;
      }

      // Show info card with animation
      function showInfo(building) {
        const card = document.getElementById("infoCard");
        const image = document.getElementById("buildingImage");
        
        document.getElementById("infoName").textContent = building.name;
        document.getElementById("infoDesc").textContent = building.desc;
        image.src = building.image;
        image.onerror = () => {
          image.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjIwMCIgeT0iMTAwIiBzdHlsZT0iZmlsbDojOTk5O2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1zaXplOjIwcHg7Zm9udC1mYW1pbHk6QXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWY7ZG9taW5hbnQtYmFzZWxpbmU6Y2VudHJhbCI+Sm95bGVucyBTdG9yZTwvdGV4dD48L3N2Zz4=';
        };

        // Update distance
        if (userPosition) {
          const distance = calculateDistance(userPosition.latitude, userPosition.longitude, building.lat, building.lng);
          document.getElementById("infoDistance").textContent = formatDistance(distance);
          if (distance < 10) {
            // Show marker when close
            document.querySelector("#joylensGpsMarker").setAttribute("visible", "true");
          }
        } else {
          document.getElementById("infoDistance").textContent = "Calculating...";
        }

        card.style.display = "block";
        setTimeout(() => {
          card.classList.remove("hidden");
          card.classList.add("show");
        }, 10);
      }

      // Hide info card with animation
      function hideInfo() {
        const card = document.getElementById("infoCard");
        card.classList.remove("show");
        card.classList.add("hidden");
        setTimeout(() => {
          card.style.display = "none";
        }, 300);
      }

      // Toggle waypoint and show/hide arrow
      function goToJoylens() {
        waypointActive = !waypointActive;
        const arrow = document.getElementById("directionArrow");
        if (waypointActive) {
          arrow.setAttribute("visible", "true");
          alert(`‚úÖ Waypoint set!\nüìç Joylens Store\nüìå ${joylens.lat.toFixed(6)}, ${joylens.lng.toFixed(6)}\n\nFollow the blue arrow! Scan the store marker when close for info.`);
        } else {
          arrow.setAttribute("visible", "false");
          alert("Waypoint deactivated");
        }
      }

      // Open Google Maps for directions
      function getDirections() {
        const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${joylens.lat},${joylens.lng}&travelmode=walking`;
        window.open(mapsUrl, '_blank');
      }

      // Custom component for marker click handling
      AFRAME.registerComponent('clickable', {
        init: function () {
          this.el.addEventListener('click', () => {
            showInfo(joylens);
          });
        }
      });

      // Custom component for real-time arrow updates
      AFRAME.registerComponent('update-arrow', {
        tick: function () {
          if (waypointActive && userPosition) {
            const arrow = this.el;
            // Calculate bearing from user to target
            const bearing = calculateBearing(
              userPosition.latitude,
              userPosition.longitude,
              joylens.lat,
              joylens.lng
            );
            // Adjust bearing with device orientation
            const adjustedBearing = (bearing - deviceHeading + 360) % 360;
            const smoothedBearing = smoothBearing(adjustedBearing);
            arrow.setAttribute('rotation', `0 ${smoothedBearing} 0`);

            // Update distance in info card if visible
            if (document.getElementById("infoCard").style.display === "block") {
              const distance = calculateDistance(
                userPosition.latitude,
                userPosition.longitude,
                joylens.lat,
                joylens.lng
              );
              document.getElementById("infoDistance").textContent = formatDistance(distance);
            }
          }
        }
      });

      // Continuous GPS tracking with indoor fallback detection
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            userPosition = position.coords;
            isIndoor = position.coords.accuracy > 20; // Assume indoor if accuracy poor (>20m)
            console.log("User position:", userPosition.latitude, userPosition.longitude, "Indoor mode:", isIndoor);
          },
          (error) => {
            console.error("GPS error:", error);
            document.getElementById("infoDistance").textContent = "Location unavailable";
            isIndoor = true; // Fallback to indoor if error
          },
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 5000
          }
        );
      }

      // Apply update-arrow component
      document.querySelector("#directionArrow").setAttribute("update-arrow", "");

      // Initialize by showing info card after 2 seconds
      setTimeout(() => {
        showInfo(joylens);
      }, 2000);
    </script>
  </body>
</html>
